{% extends "base.html" %}
{% block title %}Google Drive Authentication - SDTransfer Offloader{% endblock %}
{% block content %}
  <h2><i class="fa fa-google-drive"></i> Google Drive Authentication (rclone)</h2>

  {% if not gdrive_configured %}
  <div class="panel flash-warning">
      <h4><i class="fa fa-exclamation-triangle"></i> Configuration Needed</h4>
      <p>The rclone configuration file (<code>rclone.conf</code>) was not found or does not contain a remote named <code>[gdrive]</code>.</p>
      <p>Before proceeding, please run the following command in your Raspberry Pi terminal (as user '{{ request.remote_user if request.remote_user else 'zmakey' }}'):</p>
      <pre><code>rclone config --config /home/zmakey/sdtransfer-offloader/rclone.conf</code></pre>
      <p>Follow the prompts to:</p>
      <ol>
          <li>Create a new remote (n).</li>
          <li>Name it exactly: <code>gdrive</code></li>
          <li>Choose 'Drive' (Google Drive) as the type.</li>
          <li>Leave client_id and client_secret blank (unless you have specific needs).</li>
          <li>Choose the desired access scope (e.g., full drive access '1').</li>
          <li>Leave root_folder_id blank unless you want to restrict rclone to a specific folder ID.</li>
          <li>Leave service_account_file blank.</li>
          <li>Choose 'N' for auto config (No).</li>
          <li>Rclone will then provide a command like <code>rclone authorize "drive" ...</code>. You don't need to run that separately; this web page will handle the authorization step below.</li>
          <li>Confirm ('y') and quit ('q').</li>
      </ol>
       <p>Once done, <a href="{{ url_for('drive_auth') }}">refresh this page</a>.</p>
  </div>
  {% else %}
      <div class="panel">
        <h3>Step 1: Get Authorization Code</h3>
        {% if error_msg and not auth_url %}
           <p class="flash-error">{{ error_msg }}</p>
        {% endif %}
        {% if auth_url %}
            <p>
              Click the link below. You will be asked to log into your Google Account and grant permission for 'rclone' to access your Google Drive.
            </p>
            <p>
              <strong>Authorization Link:</strong><br>
              <a href="{{ auth_url }}" target="_blank" rel="noopener noreferrer" class="btn" style="word-break: break-all;"> <i class="fa fa-external-link-alt"></i> Authorize Rclone Access (Opens Google)</a>
            </p>
            <p>
              After granting permission, Google will display a code. Copy that code.
            </p>
        {% else %}
             <p>Could not automatically generate the authorization link. Please ensure rclone is correctly installed and configured, then <a href="{{ url_for('drive_auth') }}">try refreshing</a>.</p>
        {% endif %}
      </div>

      <div class="panel">
        <h3>Step 2: Submit Authorization Code</h3>
        <p>
          Paste the code you copied from Google into the field below and click "Submit Code". This will complete the authentication process and allow the server to upload files.
        </p>
        <form method="post" action="{{ url_for('drive_auth') }}">
          <label for="auth_token">Authorization Code from Google:</label>
          <input type="text" id="auth_token" name="auth_token" placeholder="Paste the code here" required style="width: 100%; max-width: 600px;">
          <input class="btn" type="submit" value="Submit Code">
        </form>
      </div>
  {% endif %} {# End of gdrive_configured check #}

  <a class="btn" href="{{ url_for('index') }}"><i class="fa fa-arrow-left"></i> Back to Dashboard</a>
{% endblock %}