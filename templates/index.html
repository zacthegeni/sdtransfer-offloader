{% extends "base.html" %}
{% block title %}Dashboard - SDTransfer Offloader{% endblock %}
{% block content %}
  <h2><i class="fa fa-tachometer-alt"></i> Dashboard</h2>

  <!-- STATUS BAR -->
  <div class="status-bar">
    <div class="status-item">
      <h4><i class="fa fa-hdd"></i> Free Space</h4>
      <p id="status">{{ space }}</p>
    </div>
    <div class="status-item">
      <h4><i class="fa fa-microchip"></i> CPU Usage</h4>
      <p id="cpu-usage">{{ cpu }}%</p>
    </div>
    <div class="status-item">
      <h4><i class="fa fa-memory"></i> Memory Usage</h4>
      <p id="mem-usage">{{ mem }}%</p>
    </div>
  </div>

  <!-- MAIN CONTROLS PANEL -->
  <div class="panel">
    <h3><i class="fa fa-cogs"></i> Main Controls</h3>
    <div class="button-group">
       <!-- Big Upload Button -->
      <button class="upload-btn" onclick="triggerAction('offload')">
        <i class="fa fa-sd-card"></i> Offload SD Card & Upload
      </button>
      <p class="help-text">
        Click this button to copy files from your SD card to local storage, then upload them to Google Drive.
      </p>

      <!-- Other Buttons -->
      <button class="btn" onclick="triggerAction('upload')"><i class="fa fa-cloud-upload-alt"></i> Upload Local Files</button>
      <button class="btn" onclick="triggerAction('retry')" title="Run the retry script (if configured)"><i class="fa fa-redo"></i> Retry Failed</button>
      <button class="btn" onclick="triggerAction('eject')" title="Safely unmount the SD card (if configured)"><i class="fa fa-eject"></i> Eject SD Card</button>
      <button class="btn btn-warning" onclick="triggerAction('reboot')"><i class="fa fa-power-off"></i> Reboot Pi</button>
      <button class="btn btn-danger" onclick="triggerAction('shutdown')"><i class="fa fa-stop-circle"></i> Shutdown Pi</button>
    </div>
  </div>

  <!-- SETTINGS & HELP -->
  <div class="panel">
    <h3><i class="fa fa-info-circle"></i> Settings & Help</h3>
    <p>
      <strong>Configuration:</strong> Adjust system settings, Wi-Fi, email notifications, and Google Drive authentication using the navigation bar above.
    </p>
    <p>
      <strong>Logs:</strong> Check the <a href="{{ url_for('logs') }}">Logs</a> page for details on offload and upload operations.
    </p>
     <p>
      <strong>Need Help?</strong> For assistance with rclone, refer to the <a href="https://rclone.org/docs/" target="_blank" rel="noopener noreferrer">official rclone documentation</a>.
    </p>
  </div>

  <script>
    // Function to poll basic status (like free space) periodically
    function pollStatus() {
      fetch('/status', {credentials: 'include'}) // credentials: 'include' might be needed if auth affects this endpoint
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          const statusElement = document.getElementById('status');
          if (statusElement) {
            statusElement.innerText = data.free_space;
          }
          // Add CPU/Mem polling here if desired, but they are less likely to change rapidly
          // between page loads and are already fetched on initial load.
        })
        .catch(error => {
          console.error('Error fetching status:', error);
          const statusElement = document.getElementById('status');
          if (statusElement) {
             statusElement.innerText = "Error"; // Indicate polling failure
          }
        });
    }

    // Function to trigger actions and provide feedback (optional)
    function triggerAction(actionName) {
      // Optional: Add a confirmation for dangerous actions
      if (actionName === 'reboot' || actionName === 'shutdown') {
        if (!confirm(`Are you sure you want to ${actionName} the Raspberry Pi?`)) {
          return; // Abort if user cancels
        }
      }
       // Optional: Disable buttons while action is running? More complex state needed.
      console.log(`Triggering action: ${actionName}`);
      // Redirect to the run action endpoint
      window.location.href = `/run/${actionName}`;
      // Note: Feedback will be shown via flashed messages on the redirected page load.
    }

    // Initial poll on load and set interval
    window.onload = pollStatus;
    setInterval(pollStatus, 30000); // Poll every 30 seconds
  </script>
{% endblock %}