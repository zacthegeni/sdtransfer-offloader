{% extends "base.html" %}
{% block title %}Dashboard - SDTransfer Offloader{% endblock %}
{% block content %}
  <h2>Dashboard</h2>

  <!-- STATUS BAR -->
  <div class="status-bar">
    <div class="status-item">
      <h4>Monitored Disk</h4>
       <p><i class="fa-solid fa-hard-drive"></i> <span id="status-space">{{ status.free_space_mb | default('N/A') }}</span></p>
       <p>({{ status.disk_percent | default('N/A') }}% used)</p>
    </div>
    <div class="status-item">
      <h4>CPU Usage</h4>
      <p><i class="fa fa-microchip"></i> <span id="status-cpu">{{ status.cpu_usage | default('N/A') }}</span>%</p>
    </div>
    <div class="status-item">
      <h4>Memory Usage</h4>
      <p><i class="fa fa-memory"></i> <span id="status-mem">{{ status.mem_usage | default('N/A') }}</span>%</p>
    </div>
    <!-- SD Card Status Item -->
    <div class="status-item">
        <h4>SD Card Status</h4>
        <p id="status-sd-icon">
            <i class="fa-solid fa-sd-card" style="color: {{ 'lightgreen' if status.sd_card_mounted else 'lightcoral' }}; font-size: 1.5rem; vertical-align: middle;"></i>
        </p>
        <p id="status-sd-text" style="font-size: 0.9rem; margin-top: 5px; color: #ccc;">
            {% if status.sd_card_mounted %} Mounted
            {% elif status.sd_card_path_exists %} Path Exists (Not Mounted)
            {% else %} Not Detected {% endif %}
        </p>
    </div>
  </div>

  <!-- MAIN CONTROLS PANEL -->
  <div class="panel">
    <h3>Main Controls</h3>
    <p class="help-text">Run background tasks or manage the system. Scripts provide notifications on start/completion/error.</p>
    <div class="button-group">
      <button class="btn offload-btn" onclick="location.href='{{ url_for('run_action', action='offload') }}'">
        <i class="fa-solid fa-sd-card"></i> Run Offload Now
      </button>
      {# <button class="btn upload-btn" onclick="location.href='{{ url_for('run_action', action='upload') }}'"> #}
      {#  <i class="fa-solid fa-cloud-arrow-up"></i> Run Upload Only #}
      {# </button> #}
      <button class="btn retry-btn" onclick="location.href='{{ url_for('run_action', action='retry') }}'">
        <i class="fa-solid fa-rotate-right"></i> Retry Failed Uploads
      </button>
      <button class="btn eject-btn" onclick="confirmAction('eject', 'Are you sure you want to try unmounting the SD card? Ensure no operations are running.')">
        <i class="fa-solid fa-eject"></i> Eject SD Card
      </button>
      <hr style="border-color: #333; width: 80%; margin: 20px auto; border-style: dashed;">
      <button class="btn reboot-btn" onclick="confirmAction('reboot', 'WARNING: This will reboot the Raspberry Pi immediately. Proceed?')">
        <i class="fa-solid fa-power-off"></i> Reboot Pi
      </button>
      <button class="btn shutdown-btn" onclick="confirmAction('shutdown', 'WARNING: This will shut down the Raspberry Pi immediately. Proceed?')">
        <i class="fa-solid fa-ban"></i> Shutdown Pi
      </button>
    </div>
  </div>

  <!-- SETTINGS & INFO -->
  <div class="panel">
    <h3>Info & Links</h3>
    <p>
        Configure settings using the navigation bar above. Check <a href="{{ url_for('logs') }}">Logs</a> and <a href="{{ url_for('diagnostics') }}">Diagnostics</a> for details.
    </p>
    <p>
        Ensure <a href="{{ url_for('drive_auth') }}">Google Drive Authentication</a> is complete before uploading.
    </p>
    <p>Consider setting up <strong>udev rules</strong> (see documentation/installer output) for fully automatic SD card processing upon insertion.</p>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    function pollStatus() {
      fetch("{{ url_for('status_api') }}")
        .then(response => { if (!response.ok) throw new Error(`HTTP error ${response.status}`); return response.json(); })
        .then(data => {
          document.getElementById('status-space').innerText = data.free_space_mb || 'N/A';
          document.getElementById('status-cpu').innerText = data.cpu_usage !== null ? data.cpu_usage.toFixed(1) : 'N/A';
          document.getElementById('status-mem').innerText = data.mem_usage !== null ? data.mem_usage.toFixed(1) : 'N/A';
          const sdIconElement = document.getElementById('status-sd-icon'); const sdTextElement = document.getElementById('status-sd-text');
          if (sdIconElement && sdTextElement) { const sdIcon = sdIconElement.querySelector('i'); if (data.sd_card_mounted) { sdIcon.style.color = 'lightgreen'; sdTextElement.innerText = 'Mounted'; } else { sdIcon.style.color = 'lightcoral'; sdTextElement.innerText = data.sd_card_path_exists ? 'Path Exists (Not Mounted)' : 'Not Detected'; } }
        })
        .catch(error => { console.error('Error fetching status:', error); document.getElementById('status-space').innerText = 'Error'; document.getElementById('status-cpu').innerText = 'Error'; document.getElementById('status-mem').innerText = 'Error'; const sdText = document.getElementById('status-sd-text'); const sdIcon = document.getElementById('status-sd-icon'); if(sdText) sdText.innerText = 'Error'; if(sdIcon) sdIcon.querySelector('i').style.color = 'orange'; });
    }
    function confirmAction(action, message) { if (confirm(message)) { window.location.href = "{{ url_for('run_action', action='_ACTION_') }}".replace('_ACTION_', action); } }
    const statusInterval = setInterval(pollStatus, 10000); window.addEventListener('load', pollStatus);
  </script>
{% endblock %}